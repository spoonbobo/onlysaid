name: OnlySaid CI/CD

on:
  push:
    branches:
      - development
  pull_request:
    branches:
      - development

env:
  # Build versioning
  BUILD_VERSION: ${{ github.sha }}
  BUILD_NUMBER: ${{ github.run_number }}
  
  # JFrog configuration
  JFROG_CLI_URL: ${{ secrets.JFROG_URL }}
  JFROG_CLI_ACCESS_TOKEN: ${{ secrets.JFROG_TOKEN }}
  
  # Docker registry configuration
  DOCKER_REGISTRY: ${{ secrets.JFROG_URL }}/oa-onlysaid-app-docker-dev-local
  ELECTRON_REGISTRY: oa-onlysaid-electron-dev-local

jobs:
  # Stage 1: CI - Build & Initial Publication
  ci-build-and-publish:
    name: CI - Build & Publish Artifacts
    runs-on: [self-hosted, onlysaid-runner]
    
    outputs:
      build-version: ${{ env.BUILD_VERSION }}
      docker-image-tag: ${{ steps.docker-meta.outputs.tags }}
      
    steps:
      # 1. Setup & Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Verify runner environment
      - name: Verify self-hosted runner environment
        run: |
          echo "ðŸ” Verifying self-hosted runner environment..."
          echo "Runner OS: $(uname -a)"
          echo "Current user: $(whoami)"
          echo "Working directory: $(pwd)"
          echo "Available disk space:"
          df -h
          echo "Docker version:"
          docker --version
          echo "Node.js version:"
          node --version
          echo "npm version:"
          npm --version
          echo "JFrog CLI version:"
          jfrog --version
          echo "Git version:"
          git --version
          echo "âœ… Environment verification completed"
          
      # 3. Install Node.js if not available
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      # 4. Install JFrog CLI if not available
      - name: Set up JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        
      - name: Configure JFrog CLI
        run: |
          if [ -z "${{ secrets.JFROG_URL }}" ] || [ -z "${{ secrets.JFROG_TOKEN }}" ]; then
            echo "âŒ JFrog credentials are required but not provided"
            exit 1
          fi
          
          echo "Configuring JFrog CLI..."
          
          # Use a unique server ID to avoid conflicts
          SERVER_ID="artifactory-${BUILD_NUMBER}-$(date +%s)"
          
          # Add configuration with unique ID
          jfrog config add "$SERVER_ID" --url="${{ secrets.JFROG_URL }}" --access-token="${{ secrets.JFROG_TOKEN }}" --interactive=false
          echo "JFROG_SERVER_ID=$SERVER_ID" >> $GITHUB_ENV
          echo "JFROG_CONFIGURED=true" >> $GITHUB_ENV
          echo "âœ… JFrog CLI configured successfully with server ID: $SERVER_ID"

      # 5. Test JFrog connectivity
      - name: Test JFrog connectivity
        run: |
          echo "ðŸ”— Testing JFrog connectivity from self-hosted runner..."
          
          # Test JFrog connectivity - MUST succeed
          if curl -f -s --connect-timeout 30 --max-time 30 "${{ secrets.JFROG_URL }}/artifactory/api/system/ping" > /dev/null; then
            echo "âœ… JFrog server is accessible from self-hosted runner"
            echo "JFROG_ACCESSIBLE=true" >> $GITHUB_ENV
          else
            echo "âŒ Cannot reach JFrog server from self-hosted runner"
            echo "Please verify:"
            echo "1. Runner has internet connectivity"
            echo "2. JFrog URL is correct: ${{ secrets.JFROG_URL }}"
            echo "3. Network/firewall allows outbound connections"
            echo "4. JFrog service is running"
            exit 1
          fi
        timeout-minutes: 1
        
      # 6. Dependency Management
      - name: Configure npm for JFrog Artifactory
        run: |
          echo "Setting up .npmrc for JFrog Artifactory npm proxy"
          
          # Extract hostname from JFROG_URL for npmrc
          JFROG_HOST=$(echo "${{ secrets.JFROG_URL }}" | sed 's|https\?://||')
          
          cat > .npmrc << EOF
          registry=${{ secrets.JFROG_URL }}/artifactory/api/npm/oa-npm/
          //${JFROG_HOST}/artifactory/api/npm/oa-npm/:_authToken=${{ secrets.JFROG_TOKEN }}
          //${JFROG_HOST}/artifactory/api/npm/oa-npm/:always-auth=true
          EOF
          echo "âœ… Created .npmrc for oa-npm virtual repository"
        
      - name: Install dependencies (Next.js)
        run: |
          echo "Installing Next.js dependencies..."
          
          # Set npm configuration for better reliability
          npm config set fetch-timeout 60000
          npm config set fetch-retry-mintimeout 10000
          npm config set fetch-retry-maxtimeout 60000
          npm config set fetch-retries 3
          
          # Test npm registry connectivity
          echo "Testing npm registry connectivity..."
          timeout 30s npm ping
          
          echo "Installing dependencies with npm ci..."
          npm ci --prefer-offline --no-audit
          echo "âœ… Successfully installed Next.js dependencies"
        timeout-minutes: 15
        
      - name: Install dependencies (Electron)
        run: |
          cd onlysaid-electron
          
          echo "Installing Electron dependencies..."
          
          # Set npm configuration for Electron
          npm config set fetch-timeout 60000
          npm config set fetch-retry-mintimeout 10000
          npm config set fetch-retry-maxtimeout 60000
          npm config set fetch-retries 3
          
          # Copy the .npmrc to electron directory
          echo "Copying .npmrc for JFrog registry..."
          cp ../.npmrc .
          
          # Test connectivity
          echo "Testing npm registry connectivity for Electron..."
          timeout 30s npm ping
          
          echo "Installing Electron dependencies with npm ci..."
          npm ci --prefer-offline --no-audit
          echo "âœ… Successfully installed Electron dependencies"
        timeout-minutes: 15
          
      # 7. Quality & Security Scan
      - name: Run ESLint (Next.js)
        run: |
          echo "Running Next.js ESLint..."
          npm run lint
          echo "âœ… Next.js ESLint passed"
        
      - name: Run ESLint (Electron)
        run: |
          cd onlysaid-electron
          echo "Running Electron ESLint..."
          npm run lint
          echo "âœ… Electron ESLint passed"
          
      - name: Run tests (Next.js)
        run: |
          echo "Running Next.js tests..."
          # Uncomment when tests are available
          # npm test
          echo "âœ… Next.js tests completed (no tests configured yet)"
          
      - name: Run tests (Electron)
        run: |
          cd onlysaid-electron
          echo "Running Electron tests..."
          npm test
          echo "âœ… Electron tests passed"
          
      - name: JFrog Security Scan
        run: |
          echo "Running JFrog security scan..."
          echo "JFrog server is accessible, running security scan..."
          timeout 120s jfrog audit --server-id="${JFROG_SERVER_ID:-artifactory}"
          echo "âœ… JFrog security scan completed"
        timeout-minutes: 3
        
      # 8. Build Artifacts
      - name: Build Next.js Application
        env:
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          NODE_ENV: production
        run: |
          echo "Building Next.js application..."
          npm run build
          echo "âœ… Next.js application built successfully"
          
      - name: Verify directory structure
        run: |
          echo "Current working directory: $(pwd)"
          echo "Repository contents:"
          ls -la
          echo "Verifying onlysaid-electron directory exists:"
          if [ ! -d "onlysaid-electron" ]; then
            echo "âŒ onlysaid-electron directory not found"
            exit 1
          fi
          echo "âœ… onlysaid-electron directory found"
          
      - name: Build Electron Application
        working-directory: ./onlysaid-electron
        env:
          KB_BASE_URL: ${{ secrets.KB_BASE_URL || 'http://onlysaid-dev.com/api/kb/' }}
          MICROSOFT_CLIENT_ID: ${{ secrets.MICROSOFT_CLIENT_ID || '' }}
          ONLYSAID_API_URL: ${{ secrets.ONLYSAID_API_URL || 'https://api.onlysaid.com' }}
          ONLYSAID_DOMAIN: ${{ secrets.ONLYSAID_DOMAIN || 'https://onlysaid.com' }}
          SOCKET_SERVER_URL: ${{ secrets.SOCKET_SERVER_URL || 'http://localhost:3001' }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID || '' }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET || '' }}
        run: |
          echo "Building Electron application..."
          npm run package
          echo "âœ… Electron build completed successfully"
          
      # 9. Docker Setup and Build
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Extract Docker metadata
        id: docker-meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/onlysaid-app
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=dev-latest
            
      # Build Docker Images
      - name: Build Next.js Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.next
          platforms: linux/amd64
          push: false
          tags: ${{ steps.docker-meta.outputs.tags }}
          labels: ${{ steps.docker-meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/onlysaid-app.tar
          
      - name: Build Socket Server Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./socket_server
          file: ./socket_server/Dockerfile.socket_server
          platforms: linux/amd64
          push: false
          tags: ${{ env.DOCKER_REGISTRY }}/onlysaid-socket:dev-${{ env.BUILD_VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/onlysaid-socket.tar
          
      - name: Build Knowledge Base Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.kb
          platforms: linux/amd64
          push: false
          tags: ${{ env.DOCKER_REGISTRY }}/onlysaid-kb:dev-${{ env.BUILD_VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/onlysaid-kb.tar
          
      - name: Build Documentation Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.docs
          platforms: linux/amd64
          push: false
          tags: ${{ env.DOCKER_REGISTRY }}/onlysaid-docs:dev-${{ env.BUILD_VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/onlysaid-docs.tar
          
      # 10. Publish to Artifactory (Dev Tier)
      - name: Upload Docker Images to JFrog Artifactory
        run: |
          echo "Uploading Docker images to JFrog Artifactory..."
          
          # Load and tag images
          docker load < /tmp/onlysaid-app.tar
          docker load < /tmp/onlysaid-socket.tar
          docker load < /tmp/onlysaid-kb.tar
          docker load < /tmp/onlysaid-docs.tar
          
          # Login to JFrog Docker registry
          echo "${{ secrets.JFROG_TOKEN }}" | docker login ${{ secrets.JFROG_URL }} -u admin --password-stdin
          
          # Push to oa-onlysaid-app-docker-dev-local repository
          echo "Pushing images to oa-onlysaid-app-docker-dev-local..."
          docker push ${{ env.DOCKER_REGISTRY }}/onlysaid-app:dev-${{ env.BUILD_VERSION }}
          docker push ${{ env.DOCKER_REGISTRY }}/onlysaid-socket:dev-${{ env.BUILD_VERSION }}
          docker push ${{ env.DOCKER_REGISTRY }}/onlysaid-kb:dev-${{ env.BUILD_VERSION }}
          docker push ${{ env.DOCKER_REGISTRY }}/onlysaid-docs:dev-${{ env.BUILD_VERSION }}
          echo "âœ… All Docker images uploaded successfully"
        
      - name: Upload Electron Installers to JFrog Artifactory
        run: |
          echo "Uploading Electron installers to oa-onlysaid-electron-dev-local..."
          
          cd onlysaid-electron/release/build
          
          # Verify that build artifacts exist
          if [ ! "$(ls -A .)" ]; then
            echo "âŒ No Electron build artifacts found"
            exit 1
          fi
          
          # Upload all built installers to electron dev repository
          UPLOADED_COUNT=0
          for file in *.exe *.dmg *.AppImage *.deb *.rpm; do
            if [ -f "$file" ]; then
              echo "Uploading $file to ${{ env.ELECTRON_REGISTRY }}..."
              jfrog rt u "$file" "${{ env.ELECTRON_REGISTRY }}/v${{ env.BUILD_VERSION }}/$file" \
                --server-id="${JFROG_SERVER_ID:-artifactory}" \
                --build-name="OnlySaid-Electron" \
                --build-number="${{ env.BUILD_NUMBER }}"
              UPLOADED_COUNT=$((UPLOADED_COUNT + 1))
            fi
          done
          
          if [ $UPLOADED_COUNT -eq 0 ]; then
            echo "âŒ No Electron installers were uploaded"
            exit 1
          fi
          
          echo "âœ… Successfully uploaded $UPLOADED_COUNT Electron installers"
        
      # Store artifacts for potential manual download/testing
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docker-images-${{ env.BUILD_VERSION }}
          path: /tmp/*.tar
          retention-days: 7
          
      - name: Upload Electron Installers
        uses: actions/upload-artifact@v4
        with:
          name: electron-installers-${{ env.BUILD_VERSION }}
          path: onlysaid-electron/release/build/*
          retention-days: 7
          
      # 11. Deploy to Dev Environment
      - name: Generate deployment manifests
        run: |
          echo "Generating Kubernetes deployment manifests..."
          mkdir -p k8s-manifests
          
          # Create deployment manifest template using docker registry
          cat > k8s-manifests/onlysaid-app-deployment.yaml << EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: onlysaid-app-dev
            namespace: onlysaid-dev
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: onlysaid-app-dev
            template:
              metadata:
                labels:
                  app: onlysaid-app-dev
              spec:
                containers:
                - name: onlysaid-app
                  image: ${{ env.DOCKER_REGISTRY }}/onlysaid-app:dev-${{ env.BUILD_VERSION }}
                  ports:
                  - containerPort: 3000
          EOF
          echo "âœ… Kubernetes manifests generated"
          
      - name: Upload Kubernetes Manifests
        uses: actions/upload-artifact@v4
        with:
          name: k8s-manifests-${{ env.BUILD_VERSION }}
          path: k8s-manifests/
          retention-days: 7
          
      # Summary
      - name: Build Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Version:** ${{ env.BUILD_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number:** ${{ env.BUILD_NUMBER }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Runner Type:** Self-hosted Linux" >> $GITHUB_STEP_SUMMARY
          echo "- **Runner Host:** $(hostname)" >> $GITHUB_STEP_SUMMARY
          echo "- **JFrog Configured:** âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **JFrog Accessible:** âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Registry:** oa-onlysaid-app-docker-dev-local" >> $GITHUB_STEP_SUMMARY
          echo "- **Electron Registry:** oa-onlysaid-electron-dev-local" >> $GITHUB_STEP_SUMMARY
          echo "- **NPM Registry:** oa-npm (virtual)" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Images Built:** âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **Electron Build Completed:** âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts Published to JFrog:** âœ…" >> $GITHUB_STEP_SUMMARY

      # 12. Cleanup workspace (important for self-hosted runners)
      - name: Cleanup workspace
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up workspace for self-hosted runner..."
          
          # Clean up JFrog configuration
          if [ -n "${JFROG_SERVER_ID}" ]; then
            echo "Cleaning up JFrog configuration..."
            jfrog config remove "${JFROG_SERVER_ID}" --quiet || echo "JFrog config cleanup failed"
          fi
          
          # Clean up Docker images to save space
          echo "Cleaning up Docker images..."
          docker system prune -f
          
          # Clean up npm cache
          echo "Cleaning npm cache..."
          npm cache clean --force
          
          # Clean up node_modules to save space (will be reinstalled next run)
          echo "Cleaning node_modules..."
          rm -rf node_modules
          rm -rf onlysaid-electron/node_modules
          
          # Clean up build artifacts
          echo "Cleaning build artifacts..."
          rm -rf .next
          rm -rf onlysaid-electron/release
          rm -rf /tmp/onlysaid-*.tar
          
          # Clean up temporary files
          echo "Cleaning temporary files..."
          rm -rf .npmrc
          
          echo "âœ… Workspace cleanup completed"